{% extends "base.html" %}

{% block title %}Fraud monitoring paneli{% endblock %}

{% block content %}
<main class="wrapper">
    <section class="hero">
        <!-- CHAP TOMON: FORMA -->
        <div class="hero-left">
            <h1 class="hero-title">Fraud Detection System</h1>
            <p class="hero-subtitle">
                Bank tranzaksiyalarini real vaqt rejimida baholash va xatarni aniqlash.
            </p>

            <div class="card form-card">
                {% if error %}
                    <div class="alert alert-error">
                        {{ error }}
                    </div>
                {% endif %}

                <h2 class="card-title">Tranzaksiyani baholash</h2>

                <form action="{{ url_for('ui_predict') }}" method="post">
                    <div class="form-grid">
                        <div class="field">
                            <label class="field-label" for="type">Tranzaksiya turi</label>
                            <select class="field-input" id="type" name="type">
                                {% for t in tx_types %}
                                    <option value="{{ t }}">{{ t }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="field">
                            <label class="field-label" for="timestamp">Vaqt indikatori (ixtiyoriy)</label>
                            <input
                                class="field-input"
                                type="number"
                                step="1"
                                id="timestamp"
                                name="timestamp"
                                placeholder="Masalan: 10"
                            />
                        </div>

                        <div class="field">
                            <label class="field-label" for="amount">Tranzaksiya summasi</label>
                            <input
                                class="field-input"
                                type="number"
                                step="0.01"
                                id="amount"
                                name="amount"
                                placeholder="Masalan: 100000"
                                required
                            />
                        </div>

                        <div class="field">
                            <label class="field-label" for="oldbalanceOrg">Jo‘natuvchi balans (oldin)</label>
                            <input
                                class="field-input"
                                type="number"
                                step="0.01"
                                id="oldbalanceOrg"
                                name="oldbalanceOrg"
                                placeholder="Masalan: 500000"
                            />
                        </div>

                        <div class="field">
                            <label class="field-label" for="newbalanceOrig">Jo‘natuvchi balans (keyin)</label>
                            <input
                                class="field-input"
                                type="number"
                                step="0.01"
                                id="newbalanceOrig"
                                name="newbalanceOrig"
                                placeholder="Masalan: 400000"
                            />
                        </div>

                        <div class="field">
                            <label class="field-label" for="oldbalanceDest">Oluvchi balans (oldin)</label>
                            <input
                                class="field-input"
                                type="number"
                                step="0.01"
                                id="oldbalanceDest"
                                name="oldbalanceDest"
                                placeholder="Masalan: 0"
                            />
                        </div>

                        <div class="field">
                            <label class="field-label" for="newbalanceDest">Oluvchi balans (keyin)</label>
                            <input
                                class="field-input"
                                type="number"
                                step="0.01"
                                id="newbalanceDest"
                                name="newbalanceDest"
                                placeholder="Masalan: 100000"
                            />
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn primary">
                            Tranzaksiyani baholash
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- O'NG TOMON: CYBER RADAR + NATIJA + HISTORY -->
        <div class="hero-right">
            <!-- CYBER ANIMASIYA KARTASI -->
            <div class="card cyber-card">
                <div class="cyber-info">
                    <h2 class="cyber-title">Real-time fraud radari</h2>
                    <p class="cyber-text">
                        Tizim tranzaksiyalar oqimini uzluksiz kuzatib boradi va shubhali
                        operatsiyalarni alohida ajratib ko‘rsatish uchun risk ballarini
                        yangilab boradi.
                    </p>
                </div>

                <div class="cyber-anim">
                    <div class="cyber-orbit orbit-1"></div>
                    <div class="cyber-orbit orbit-2"></div>
                    <div class="cyber-orbit orbit-3"></div>
                    <div class="cyber-core"></div>
                </div>
            </div>

            <!-- SO'NGGI BAHOLASH KARTASI -->
            {% if result %}
                {% set is_fraud = (result.prediction == 1) %}
                {% set prob = result.fraud_probability %}

                <div class="card card-metric result-animated">
                    <h2 class="card-title">So‘nggi baholash</h2>

                    <div class="prediction-badge {{ 'fraud' if is_fraud else 'normal' }}">
                        {% if is_fraud %}
                            Fraud risk yuqori
                        {% else %}
                            Fraud aniqlanmadi
                        {% endif %}
                    </div>

                    <div class="metric-row">
                        <span class="metric-label">Fraud ehtimoli</span>
                        <span class="metric-value">
                            {{ (prob * 100) | round(2) }}%
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="metric-label">Risk darajasi</span>
                        <span class="metric-value">
                            {% if prob < 0.10 %}
                                <span class="risk-pill risk-low">Low</span>
                            {% elif prob < 0.30 %}
                                <span class="risk-pill risk-medium">Medium</span>
                            {% else %}
                                <span class="risk-pill risk-high">High</span>
                            {% endif %}
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="metric-label">Model threshold</span>
                        <span class="metric-value">
                            {{ (result.threshold * 100) | round(0) }}%
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="metric-label">Model qarori</span>
                        <span class="metric-value">
                            {% if is_fraud %}
                                Fraud (1)
                            {% else %}
                                Normal (0)
                            {% endif %}
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="metric-label">Tranzaksiya turi</span>
                        <span class="metric-value">
                            {{ result.input.type if result.input.type is defined else result.input['type'] }}
                        </span>
                    </div>

                    <div class="metric-row">
                        <span class="metric-label">Summasi</span>
                        <span class="metric-value">
                            {{ "{:,.0f}".format(result.input.amount if result.input.amount is defined else result.input['amount']) }} so‘m
                        </span>
                    </div>

                    <p class="card-note">
                        Model natijasi bank siyosati bilan birgalikda qo‘llanilganda, yuqori
                        riskga ega operatsiyalarni qo‘shimcha verifikatsiyadan o‘tkazish
                        imkonini beradi.
                    </p>
                </div>
            {% endif %}

            <!-- HISTORY KARTASI -->
            <div class="card card-history">
                <h2 class="card-title">So‘nggi baholangan tranzaksiyalar</h2>

                {% if history and history|length > 0 %}
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Vaqt</th>
                                <th>Turi</th>
                                <th>Summasi</th>
                                <th>Fraud ehtimoli</th>
                                <th>Qaror</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for h in history | reverse %}
                                <tr>
                                    <td>{{ h.time }}</td>
                                    <td>{{ h.type }}</td>
                                    <td>{{ "{:,.0f}".format(h.amount) }}</td>
                                    <td>{{ (h.fraud_probability * 100) | round(2) }}%</td>
                                    <td>
                                        {% if h.prediction == 1 %}
                                            <span class="tag tag-fraud">Fraud</span>
                                        {% else %}
                                            <span class="tag tag-normal">Normal</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="card-note" style="margin-top:6px;">
                        Hozircha baholangan tranzaksiyalar ro‘yxati bo‘sh. Yuqoridagi formani
                        to‘ldirib, yangi tranzaksiyani baholab ko‘rishingiz mumkin.
                    </p>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- PASTKI CYBER ANIMATSIYA STRIP -->
    <section class="cyber-strip">
        <div class="cyber-strip-inner">
            <p class="cyber-strip-text">
                Tizim tranzaksiyalar oqimi bo‘yicha anomal holatlarni aniqlash uchun
                doimiy ravishda monitoring olib boradi va risk indikatorlarini yangilab turadi.
            </p>
        </div>
    </section>
</main>
{% endblock %}
